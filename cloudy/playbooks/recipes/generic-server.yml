# Recipe: Generic Server Setup (Phase 2)
# Purpose: Complete server configuration after security hardening
# Prerequisites: Must run hardening.yml first
# Usage: ansible-playbook playbooks/recipes/generic-server.yml -i inventory/hosts.yml

---
- name: Generic Server Setup (Admin User Phase)
  hosts: generic_servers
  gather_facts: true
  become: true
  
  vars:
    # Override these in inventory or command line
    setup_swap: true
    setup_security: true
    
  pre_tasks:
    - name: Display server information
      debug:
        msg: |
          ğŸš€ Starting Generic Server Setup (Phase 2)
          Target: {{ inventory_hostname }} ({{ ansible_host }})
          User: {{ ansible_user }}
          Port: {{ ansible_port | default(22022) }}
          
          ğŸ“‹ Prerequisites Check:
          â”œâ”€â”€ Admin user: {{ admin_user }}
          â”œâ”€â”€ SSH port: {{ ssh_port }}
          â”œâ”€â”€ Root login: Should be disabled
          â””â”€â”€ SSH keys: Should be configured
          
  tasks:
    # System Initialization
    - name: Initialize system
      include_tasks: ../../tasks/sys/core/init.yml
      tags: [system, init]
      
    # Hostname Configuration
    - name: Configure hostname
      include_tasks: ../../tasks/sys/core/hostname.yml
      vars:
        target_hostname: "{{ hostname }}"
      tags: [system, hostname]
      
    # Git Configuration
    - name: Install git
      include_tasks: ../../tasks/sys/core/install-git.yml
      tags: [system, git]
      
    - name: Configure git for root
      include_tasks: ../../tasks/sys/core/configure-git.yml
      vars:
        target_user: root
        git_name: "{{ git_user_full_name }}"
        git_email: "{{ git_user_email }}"
      tags: [system, git]
      
    - name: Configure git for admin user
      include_tasks: ../../tasks/sys/core/configure-git.yml
      vars:
        target_user: "{{ admin_user }}"
        git_name: "{{ git_user_full_name }}"
        git_email: "{{ git_user_email }}"
      tags: [users, admin, git]
      
    # Firewall Setup (additional rules beyond SSH)
    - name: Secure server with firewall
      include_tasks: ../../tasks/sys/firewall/secure-server.yml
      tags: [firewall, security]
      
    # System Configuration
    - name: Configure timezone
      include_tasks: ../../tasks/sys/timezone/configure.yml
      tags: [system, timezone]
      
    - name: Configure swap
      include_tasks: ../../tasks/sys/swap/configure.yml
      when: setup_swap | bool
      tags: [system, swap]
      
    # Security Hardening (additional packages)
    - name: Install security packages
      include_tasks: ../../tasks/sys/security/install-common.yml
      when: setup_security | default(true) | bool
      tags: [security, packages]
      
    # Final Validation
    - name: Validate admin user access and configuration
      include_tasks: ../../tasks/sys/core/validate-admin-access.yml
      vars:
        admin_password: "{{ admin_password }}"
      tags: [validation, admin]
      
  post_tasks:
    - name: Display completion summary
      debug:
        msg: |
          ğŸ‰ âœ… GENERIC SERVER SETUP COMPLETED SUCCESSFULLY!
          
          ğŸ“‹ Configuration Summary:
             â”œâ”€â”€ Hostname: {{ hostname }}
             â”œâ”€â”€ Timezone: {{ timezone }}
             â”œâ”€â”€ Admin User: {{ admin_user }} (groups: {{ admin_groups }})
             â”œâ”€â”€ SSH Port: {{ ssh_port }}
             â”œâ”€â”€ Root Login: Disabled (secured in Phase 1)
             â”œâ”€â”€ SSH Keys: Configured (secured in Phase 1)
             â””â”€â”€ Firewall: UFW enabled and configured
          
          ğŸš€ Generic server foundation is ready for specialized deployments!
          
          ğŸ” SSH Access Information:
             â””â”€â”€ Connect as: {{ admin_user }}@{{ ansible_host }}:{{ ssh_port }}
             â””â”€â”€ Authentication: SSH key + sudo password for privileged operations
             â””â”€â”€ Root login: DISABLED (security hardened)
          
          ğŸ“š Next Steps:
             â€¢ Deploy specialized services (web-server.yml, database-server.yml, etc.)
             â€¢ Configure application-specific settings
             â€¢ Set up monitoring and backups
          
          ğŸ›¡ï¸  Security Status: HARDENED âœ…