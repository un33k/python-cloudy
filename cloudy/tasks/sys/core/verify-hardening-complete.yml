# Verify All Hardening Components Are Complete
# Checks that all security measures are properly in place
# Usage: include_tasks: tasks/sys/core/verify-hardening-complete.yml

---
- name: Initialize verification results
  set_fact:
    verification_results: {}
    hardening_verified: false

- name: Check if admin user exists
  user:
    name: "{{ admin_user }}"
    state: present
  register: admin_user_check
  check_mode: true
  failed_when: false

- name: Verify admin user exists
  set_fact:
    verification_results: "{{ verification_results | combine({'admin_user_exists': admin_user_check.changed == false}) }}"

- name: Check SSH port configuration
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Port\s+'
    line: "Port {{ ssh_port | default(22022) }}"
    state: present
  register: ssh_port_check
  check_mode: true
  failed_when: false

- name: Verify SSH port is configured
  set_fact:
    verification_results: "{{ verification_results | combine({'ssh_port_configured': ssh_port_check.changed == false}) }}"

- name: Check root login disabled
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin\s+'
    line: 'PermitRootLogin no'
    state: present
  register: root_login_check
  check_mode: true
  failed_when: false

- name: Verify root login is disabled
  set_fact:
    verification_results: "{{ verification_results | combine({'root_login_disabled': root_login_check.changed == false}) }}"

- name: Check password authentication disabled
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PasswordAuthentication\s+'
    line: 'PasswordAuthentication no'
    state: present
  register: password_auth_check
  check_mode: true
  failed_when: false

- name: Verify password authentication is disabled
  set_fact:
    verification_results: "{{ verification_results | combine({'password_auth_disabled': password_auth_check.changed == false}) }}"

- name: Check UFW firewall status
  command: ufw status
  register: ufw_status_check
  changed_when: false
  failed_when: false

- name: Verify UFW firewall is active
  set_fact:
    verification_results: "{{ verification_results | combine({'ufw_firewall_active': 'Status: active' in ufw_status_check.stdout}) }}"

- name: Check admin user SSH key
  stat:
    path: "/home/{{ admin_user }}/.ssh/authorized_keys"
  register: ssh_key_check

- name: Verify admin user has SSH keys
  set_fact:
    verification_results: "{{ verification_results | combine({'admin_ssh_keys_installed': ssh_key_check.stat.exists}) }}"

- name: Check admin user sudo access
  command: sudo -n whoami
  register: sudo_check
  changed_when: false
  failed_when: false
  become: false

- name: Verify admin user has sudo access
  set_fact:
    verification_results: "{{ verification_results | combine({'admin_sudo_access': sudo_check.rc == 0}) }}"

- name: Calculate overall hardening status
  set_fact:
    hardening_verified: "{{ 
      verification_results.admin_user_exists and
      verification_results.ssh_port_configured and
      verification_results.root_login_disabled and
      verification_results.password_auth_disabled and
      verification_results.ufw_firewall_active and
      verification_results.admin_ssh_keys_installed and
      verification_results.admin_sudo_access
    }}"

- name: Display hardening verification results
  debug:
    msg: |
      ğŸ” Hardening Verification Results:
      â”œâ”€â”€ Admin user exists: {{ 'âœ…' if verification_results.admin_user_exists else 'âŒ' }}
      â”œâ”€â”€ SSH port configured ({{ ssh_port | default(22022) }}): {{ 'âœ…' if verification_results.ssh_port_configured else 'âŒ' }}
      â”œâ”€â”€ Root login disabled: {{ 'âœ…' if verification_results.root_login_disabled else 'âŒ' }}
      â”œâ”€â”€ Password auth disabled: {{ 'âœ…' if verification_results.password_auth_disabled else 'âŒ' }}
      â”œâ”€â”€ UFW firewall active: {{ 'âœ…' if verification_results.ufw_firewall_active else 'âŒ' }}
      â”œâ”€â”€ Admin SSH keys installed: {{ 'âœ…' if verification_results.admin_ssh_keys_installed else 'âŒ' }}
      â””â”€â”€ Admin sudo access: {{ 'âœ…' if verification_results.admin_sudo_access else 'âŒ' }}
      
      ğŸ¯ Overall Status: {{ 'âœ… HARDENING COMPLETE' if hardening_verified else 'âŒ HARDENING INCOMPLETE' }}

- name: Set hardening verification status
  set_fact:
    hardening_verification_complete: "{{ hardening_verified }}"
    
- name: Fail if hardening verification fails
  fail:
    msg: |
      âŒ Hardening verification failed!
      One or more security components are not properly configured.
      Please review the verification results above and fix any issues.
  when: not hardening_verified